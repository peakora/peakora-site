<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Peakora Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- iOS PWA support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Peakora">
  <link rel="apple-touch-icon" href="./assets/peakora-icon-192.png">

  <!-- Neutral premium Peakora dot favicon -->
  <link rel="icon" href="data:image/svg+xml,
    <svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'>
      <circle cx='32' cy='32' r='28' fill='%23f5b35c'/>
    </svg>">

  <!-- Correct manifest path -->
  <link rel="manifest" href="./manifest.json">

  <!-- Styles -->
  <link rel="stylesheet" href="./assistant.css" />
</head>

<body>
  <div class="assistant-shell">
    <div class="assistant-card fade">
      <header class="assistant-header">
        <div class="brand">
          <span class="brand-mark"></span>
          <span class="brand-name">PEAKORA</span>
        </div>
        <div class="brand-tagline">Gentle guidance. Real momentum.</div>
      </header>

      <div class="assistant-progress">
        <div class="progress-label" id="progress-label">Step 1 of 13</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>

      <main id="step-container" class="assistant-body fade"></main>

      <footer class="assistant-footer">
        <span>Peakora Assistant · This is not medical advice.</span>
      </footer>
    </div>
  </div>

  <script>
    /* INSTALL + DEVICE DETECTION */
    let deferredPrompt = null;
    let isInstalled = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;

    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isDesktop = !isMobile;

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    const steps = [
      "welcome",
      "explanation",
      "goal",
      "challenge",
      "time",
      "insight",
      "extended1",
      "extended2",
      "email",
      "processing",
      "recommendations",
      "pricing",
      "done",
      "returning",
      "daily_intro",
      "daily_checkin",
      "daily_summary",
      "install_prompt",
      "home",
      "exit"
    ];

    const onboardingSteps = [
      "welcome",
      "explanation",
      "goal",
      "challenge",
      "time",
      "insight",
      "extended1",
      "extended2",
      "email",
      "processing",
      "recommendations",
      "pricing",
      "done"
    ];

    const STORAGE_KEY = "peakora_assistant_state_v1";
    const CHECKINS_KEY = "peakora_checkins_v1";

    const state = {
      stepIndex: 0,
      answers: {},
      email: "",
      completed: false,
      installPromptShown: false
    };

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      try {
        const parsed = JSON.parse(raw);
        state.stepIndex = parsed.stepIndex || 0;
        state.answers = parsed.answers || {};
        state.email = parsed.email || "";
        state.completed = !!parsed.completed;
        state.installPromptShown = !!parsed.installPromptShown;
        return true;
      } catch {
        return false;
      }
    }

    function clearState() {
      localStorage.removeItem(STORAGE_KEY);
      state.stepIndex = 0;
      state.answers = {};
      state.email = "";
      state.completed = false;
      state.installPromptShown = false;
    }

    function getCheckins() {
      const raw = localStorage.getItem(CHECKINS_KEY);
      if (!raw) return [];
      try {
        return JSON.parse(raw) || [];
      } catch {
        return [];
      }
    }

    function addCheckin(feeling) {
      const list = getCheckins();
      const today = new Date().toISOString().slice(0, 10);
      list.push({ date: today, feeling });
      localStorage.setItem(CHECKINS_KEY, JSON.stringify(list.slice(-30)));
    }

    function setProgress() {
      const label = document.getElementById("progress-label");
      const fill = document.getElementById("progress-fill");
      const key = steps[state.stepIndex];
      const idx = onboardingSteps.indexOf(key);

      if (idx === -1) {
        label.textContent = "Peakora Assistant";
        fill.style.width = "0%";
        return;
      }

      const stepNum = idx + 1;
      const total = onboardingSteps.length;
      label.textContent = `Step ${stepNum} of ${total}`;
      fill.style.width = `${(stepNum / total) * 100}%`;
    }

    function goToStepKey(key) {
      const idx = steps.indexOf(key);
      if (idx === -1) return;
      state.stepIndex = idx;
      saveState();
      renderStep();
    }

    function goToNext() {
      state.stepIndex += 1;
      saveState();
      renderStep();
    }

    function goToPrevious() {
      if (state.stepIndex === 0) return;
      state.stepIndex -= 1;
      saveState();
      renderStep();
    }

    function fadeIn() {
      const card = document.querySelector(".assistant-card");
      const body = document.querySelector(".assistant-body");
      card.classList.remove("fade");
      body.classList.remove("fade");
      void card.offsetWidth;
      card.classList.add("fade");
      body.classList.add("fade");
    }

    /* Mood bubbles helpers + placeholder */

    const PLACEHOLDER_WEEK = [
      { date: "2026-01-21", feeling: "tired" },
      { date: "2026-01-22", feeling: "steady" },
      { date: "2026-01-23", feeling: "wired" },
      { date: "2026-01-24", feeling: "flat" },
      { date: "2026-01-25", feeling: "hopeful" },
      { date: "2026-01-26", feeling: "better" },
      { date: "2026-01-27", feeling: "light" }
    ];

    function getMoodFamily(feeling) {
      const f = (feeling || "").toLowerCase();
      if (!f) return "neutral";

      if (f.includes("tired") || f.includes("drained") || f.includes("sad") || f.includes("heavy")) {
        return "heavy";
      }
      if (f.includes("wired") || f.includes("overwhelm") || f.includes("anxious")) {
        return "anxious";
      }
      if (f.includes("hopeful") || f.includes("better") || f.includes("light") || f.includes("uplift")) {
        return "hopeful";
      }
      if (f.includes("ready") || f.includes("strong") || f.includes("energ")) {
        return "energized";
      }
      if (f.includes("flat")) {
        return "neutral";
      }
      if (f.includes("steady") || f.includes("okay") || f.includes("ok")) {
        return "neutral";
      }
      return "neutral";
    }

    function getMoodColor(family) {
      switch (family) {
        case "heavy": return "#E8A0A0";
        case "anxious": return "#F5C26B";
        case "hopeful": return "#AEE6C5";
        case "energized": return "#6EC8C8";
        case "neutral":
        default: return "#F5B35C";
      }
    }

    function getMoodSize(feeling) {
      const f = (feeling || "").toLowerCase();
      if (f.includes("tired")) return 26;
      if (f.includes("steady")) return 32;
      if (f.includes("wired")) return 28;
      if (f.includes("flat")) return 30;
      if (f.includes("hopeful")) return 36;
      if (f.includes("better")) return 38;
      if (f.includes("light")) return 40;
      return 30;
    }

    function getLast7CheckinsOrPlaceholder() {
      const real = getCheckins();
      if (real && real.length >= 1) {
        return real.slice(-7);
      }
      return PLACEHOLDER_WEEK;
    }

    function renderMoodBubbles() {
      const canvas = document.getElementById("mood-bubble-canvas");
      const summaryEl = document.getElementById("mood-summary-text");
      if (!canvas || !summaryEl) return;

      const data = getLast7CheckinsOrPlaceholder();
      canvas.innerHTML = "";

      if (!data.length) {
        summaryEl.textContent = "You haven’t checked in yet this week.";
        return;
      }

      const width = canvas.clientWidth || 320;
      const height = canvas.clientHeight || 160;
      const count = data.length;

      const xStep = count > 1 ? (width - 40) / (count - 1) : 0;
      const yBase = height / 2;

      const families = [];
      const feelingsSequence = [];

      data.forEach((item, index) => {
        const feeling = item.feeling || item.mood || "";
        const family = getMoodFamily(feeling);
        const color = getMoodColor(family);
        const size = getMoodSize(feeling);

        families.push(family);
        feelingsSequence.push((feeling || "").toLowerCase() || "…");

        const x = 20 + xStep * index;
        const drift = ((index % 2 === 0) ? -1 : 1) * (4 + (index % 3));
        const y = yBase + drift;

        const bubble = document.createElement("div");
        bubble.className = "mood-bubble";
        bubble.style.width = size + "px";
        bubble.style.height = size + "px";
        bubble.style.left = (x - size / 2) + "px";
        bubble.style.top = (y - size / 2) + "px";
        bubble.style.background = color;

        bubble.style.animationDelay = (index * 0.6) + "s";

        bubble.title = feeling || "No label";

        canvas.appendChild(bubble);
      });

      const familyCounts = families.reduce((acc, f) => {
        acc[f] = (acc[f] || 0) + 1;
        return acc;
      }, {});
      let dominantFamily = "neutral";
      let maxCount = 0;
      Object.keys(familyCounts).forEach(f => {
        if (familyCounts[f] > maxCount) {
          maxCount = familyCounts[f];
          dominantFamily = f;
        }
      });

      const summaryColor = getMoodColor(dominantFamily);
      const summaryBubble = document.createElement("div");
      summaryBubble.className = "week-summary-bubble";
      summaryBubble.style.background = summaryColor;

      canvas.appendChild(summaryBubble);
      summaryBubble.style.position = "absolute";
      summaryBubble.style.left = (width - 48) + "px";
      summaryBubble.style.top = "8px";

      const sequenceText = feelingsSequence.join(" → ");
      summaryEl.textContent = `This week leaned toward: ${sequenceText}.`;
    }

    function renderStep() {
      fadeIn();
      const container = document.getElementById("step-container");
      const key = steps[state.stepIndex];
      setProgress();

      if (key === "welcome") {
        container.innerHTML = `
          <div class="step">
            <h1>Hi, I’m Peakora.</h1>
            <p>Let’s take a gentle step toward the version of you that feels more grounded and steady.</p>
            <div class="actions">
              <button class="btn secondary" onclick="handleBackToHome()">Back</button>
              <button class="btn primary" onclick="goToStepKey('explanation')">Begin</button>
            </div>
          </div>`;
        return;
      }

      if (key === "explanation") {
        container.innerHTML = `
          <div class="step">
            <h2>How this works</h2>
            <p>I’ll ask a few simple questions about your energy, your time, and what’s been weighing on you.</p>
            <p>Then I’ll shape a 7‑day plan that feels doable, not overwhelming.</p>
            <div class="actions">
              <button class="btn secondary" onclick="goToPrevious()">Back</button>
              <button class="btn primary" onclick="goToStepKey('goal')">Continue</button>
            </div>
          </div>`;
        return;
      }

      if (key === "goal") {
        container.innerHTML = `
          <div class="step">
            <h2>What’s one area you’d like to feel better in?</h2>
            <textarea class="input" id="goal-input" placeholder="Sleep, stress, focus, movement… whatever feels true."></textarea>
            <div class="actions">
              <button class="btn secondary" onclick="goToPrevious()">Back</button>
              <button class="btn primary" onclick="handleGoal()">Continue</button>
            </div>
          </div>`;
        return;
      }

      if (key === "challenge") {
        container.innerHTML = `
          <div class="step">
            <h2>What’s been making this hard lately?</h2>
            <textarea class="input" id="challenge-input" placeholder="Be honest. Overwhelm, time, burnout, pain…"></textarea>
            <div class="actions">
              <button class="btn secondary" onclick="goToPrevious()">Back</button>
              <button class="btn primary" onclick="handleChallenge()">Continue</button>
            </div>
          </div>`;
        return;
      }

      if (key === "time") {
        container.innerHTML = `
          <div class="step">
            <h2>How much time feels doable for you right now?</h2>
            <div class="options">
              <button class="btn ghost" onclick="handleTime('5–10 minutes')">5–10 minutes</button>
              <button class="btn ghost" onclick="handleTime('15–20 minutes')">15–20 minutes</button>
              <button class="btn ghost" onclick="handleTime('30+ minutes')">30+ minutes</button>
            </div>
            <div class="actions">
              <button class="btn secondary" onclick="goToPrevious()">Back</button>
            </div>
          </div>`;
        return;
      }

      if (key === "insight") {
        container.innerHTML = `
          <div class="step">
            <h2>Is there anything else I should know about your energy or mood lately?</h2>
            <textarea class="input" id="insight-input" placeholder="You can skip this if nothing comes to mind."></textarea>
            <div class="actions">
              <button class="btn secondary" onclick="goToPrevious()">Back</button>
              <button class="btn primary" onclick="handleInsight()">Continue</button>
            </div>
          </div>`;
        return;
      }

      if (key === "extended1") {
        container.innerHTML = `
          <div class="step">
            <h2>What would feel like a gentle win this week?</h2>
            <textarea class="input" id="extended1-input" placeholder="Something small, kind, and realistic."></textarea>
            <div class="actions">
              <button class="btn secondary" onclick="goToPrevious()">Back</button>
              <button class="btn primary" onclick="handleExtended1()">Continue</button>
            </div>
          </div>`;
        return;
      }

      if (key === "extended2") {
        container.innerHTML = `
          <div class="step">
            <h2>What tends to throw you off when you try to make changes?</h2>
            <textarea class="input" id="extended2-input" placeholder="Patterns, triggers, thoughts…"></textarea>
            <div class="actions">
              <button class="btn secondary" onclick="goToPrevious()">Back</button>
              <button class="btn primary" onclick="handleExtended2()">Continue</button>
            </div>
          </div>`;
        return;
      }

      if (key === "email") {
        container.innerHTML = `
          <div class="step">
            <h2>Where should I send your plan?</h2>
            <input type="email" class="input" id="email-input" placeholder="you@example.com" value="${state.email}">
            <div class="actions">
              <button class="btn secondary" onclick="goToPrevious()">Back</button>
              <button class="btn primary" onclick="handleEmail()">Send my plan</button>
            </div>
          </div>`;
        return;
      }

      if (key === "processing") {
        container.innerHTML = `
          <div class="step step-centered">
            <h2>One moment</h2>
            <p>I’m shaping your plan with everything you shared.</p>
            <div class="loader"></div>
          </div>`;
        setTimeout(() => goToStepKey("recommendations"), 2400);
        return;
      }

      if (key === "recommendations") {
        container.innerHTML = `
          <div class="step">
            <h2>Your plan is ready</h2>
            <p>I’ve sent it to <strong>${state.email}</strong>.</p>
            <p>Here’s a small preview of what you’ll find inside:</p>
            <ul class="preview-list">
              <li>Daily focus that matches your energy</li>
              <li>One anchor habit to keep you steady</li>
              <li>Built‑in forgiveness for off days</li>
            </ul>
            <div class="actions">
              <button class="btn secondary" onclick="goToPrevious()">Back</button>
              <button class="btn primary" onclick="goToStepKey('pricing')">Continue</button>
            </div>
          </div>`;
        return;
      }

      if (key === "pricing") {
        container.innerHTML = `
          <div class="step">
            <h2>What’s coming next</h2>
            <p>Right now, Peakora is free. Soon, you’ll be able to:</p>
            <ul class="preview-list">
              <li>Save multiple plans</li>
              <li>Track gentle daily check‑ins</li>
              <li>See patterns and insights over time</li>
            </ul>
            <p>You’ll also be able to add Peakora to your home screen for quick access.</p>
            <div class="actions">
              <button class="btn secondary" onclick="goToPrevious()">Back</button>
              <button class="btn primary" onclick="goToStepKey('done')">Finish</button>
            </div>
          </div>`;
        return;
      }

      if (key === "done") {
        state.completed = true;
        saveState();
        container.innerHTML = `
          <div class="step step-centered">
            <h2>Your plan is on its way</h2>
            <p>You showed up for yourself today. That matters more than you think.</p>
            <p class="soft-note">Come back anytime for a new plan or a gentle check‑in.</p>
          </div>`;
        setTimeout(() => {
          if (!isInstalled && !state.installPromptShown) {
            state.installPromptShown = true;
            saveState();
            goToStepKey("install_prompt");
          } else {
            goToStepKey("home");
          }
        }, 800);
        return;
      }

      if (key === "returning") {
        container.innerHTML = `
          <div class="step">
            <h2>Welcome back</h2>
            <p>Do you want to start a fresh plan or check in with how you’re feeling today?</p>
            <div class="options vertical">
              <button class="btn ghost" onclick="handleDailyStart()">Daily check‑in</button>
              <button class="btn ghost" onclick="restartOnboarding()">Start a new 7‑day plan</button>
            </div>
          </div>`;
        if (!isInstalled) {
          container.innerHTML += `
            <div class="actions" style="margin-top: 20px; justify-content: center;">
              <button class="btn primary" onclick="goToStepKey('install_prompt')">Install Peakora</button>
            </div>`;
        }
        return;
      }

      if (key === "daily_intro") {
        container.innerHTML = `
          <div class="step">
            <h2>Let’s do a quick check‑in</h2>
            <p>Just a few gentle questions to see where you’re at today.</p>
            <div class="actions">
              <button class="btn secondary" onclick="goToStepKey('home')">Back</button>
              <button class="btn primary" onclick="goToStepKey('daily_checkin')">Begin</button>
            </div>
          </div>`;
        return;
      }

      if (key === "daily_checkin") {
        container.innerHTML = `
          <div class="step">
            <h2>How are you feeling right now?</h2>
            <textarea class="input" id="daily-checkin-input" placeholder="Tired, okay, wired, flat, hopeful… whatever is true."></textarea>
            <div class="actions">
              <button class="btn secondary" onclick="goToStepKey('daily_intro')">Back</button>
              <button class="btn primary" onclick="handleDailyCheckin()">Continue</button>
            </div>
          </div>`;
        return;
      }

      if (key === "daily_summary") {
        const feeling = state.answers.daily_checkin || "how you’re feeling today";
        container.innerHTML = `
          <div class="step step-centered">
            <h2>Thank you for checking in</h2>
            <p>I’ve noted ${feeling.toLowerCase()} as part of your ongoing pattern.</p>
            <p class="soft-note">Small moments of honesty like this are what slowly shift things.</p>
            <div class="actions">
              <button class="btn secondary" onclick="goToStepKey('daily_checkin')">Back</button>
              <button class="btn primary" onclick="goToStepKey('home')">Done</button>
            </div>
          </div>`;
        return;
      }

      if (key === "install_prompt") {
        const deviceMessage = isDesktop
          ? `You can install Peakora right from your browser — just tap the install icon above. And if you ever want it on your phone or tablet, that’s available too.`
          : `You can add Peakora to your home screen for a calmer, faster experience. And if you prefer using it on your laptop, that’s available too.`;

        container.innerHTML = `
          <div class="step step-centered">
            <h2>Make Peakora your space</h2>
            <p class="soft-note">${deviceMessage}</p>

            <ul class="preview-list" style="margin-top: 14px; text-align: left;">
              <li>One‑tap access to your daily check‑ins</li>
              <li>Your 7‑day plans available even offline</li>
              <li>A quiet space without browser tabs or noise</li>
              <li>Faster loading and smoother transitions</li>
              <li>New tools coming soon: mood tracker, micro‑journal, breath reset</li>
            </ul>

            <div class="actions" style="margin-top: 20px; justify-content: center;">
              <button class="btn primary" onclick="triggerInstall()">Install Peakora</button>
            </div>

            <div class="actions" style="margin-top: 8px; justify-content: center;">
              <button class="btn ghost" onclick="goToStepKey('home')">Maybe later</button>
            </div>
          </div>`;
        return;
      }

      if (key === "home") {
        container.innerHTML = `
          <div class="step">

            <div class="card">
              <h2>Today’s Anchor</h2>
              <p class="soft-note" id="anchor-line">
                Take one slow breath before you open your next app.
              </p>
              <div class="actions">
                <button class="btn ghost" onclick="openHeavyDay()">More like this</button>
              </div>
            </div>

            <div class="card">
              <h2>Your Plan</h2>
              <p><strong>You’re focusing on:</strong> ${state.answers.goal || "—"}</p>
              <p><strong>Your gentle win:</strong> ${state.answers.extended1 || "—"}</p>
              <p><strong>Your anchor habit:</strong> ${state.answers.extended2 || "—"}</p>
              <p><strong>Your pace:</strong> ${state.answers.time || "—"}</p>
              <div class="actions">
                <button class="btn ghost" onclick="viewFullPlan()">View full plan</button>
              </div>
            </div>

            <div class="card">
              <h2>How are you feeling today?</h2>
              <p class="soft-note">A soft moment to notice where you’re at.</p>
              <div class="actions">
                <button class="btn primary" onclick="goToStepKey('daily_intro')">Start check‑in</button>
              </div>
              <p class="tiny-note">Takes less than 30 seconds.</p>
            </div>

            <div class="card">
              <h2>Tools for right now</h2>
              <div class="actions vertical">
                <button class="btn ghost" onclick="openBreathReset()">Breath Reset (10 sec)</button>
                <button class="btn ghost" onclick="openMicroJournal()">Micro‑Journal (3 lines)</button>
                <button class="btn ghost" onclick="openHeavyDay()">Today Feels Heavy</button>
              </div>
              <p class="tiny-note">Tiny tools to steady your day.</p>
            </div>

            <div class="card">
              <h2>Your week at a glance</h2>
              <div id="mood-bubble-canvas" class="mood-bubble-canvas"></div>
              <p class="tiny-note" id="mood-summary-text"></p>
            </div>

          </div>

          <footer class="assistant-footer" style="margin-top: 40px;">
            © 2026 Peakora™ — For a Better You.
          </footer>
        `;
        renderMoodBubbles();
        return;
      }

      if (key === "exit") {
        container.innerHTML = `
          <div class="step step-centered">
            <h2>We’re done for now</h2>
            <p>You can close this tab whenever you’re ready.</p>
            <p class="soft-note">When you’re back, I’ll be right where you left me.</p>
          </div>`;
        return;
      }
    }

    /* HANDLERS */

    function handleGoal() {
      const el = document.getElementById("goal-input");
      const value = (el.value || "").trim();
      if (!value) {
        el.classList.add("input-error");
        return;
      }
      el.classList.remove("input-error");
      state.answers.goal = value;
      saveState();
      goToStepKey("challenge");
    }

    function handleChallenge() {
      const el = document.getElementById("challenge-input");
      const value = (el.value || "").trim();
      if (!value) {
        el.classList.add("input-error");
        return;
      }
      el.classList.remove("input-error");
      state.answers.challenge = value;
      saveState();
      goToStepKey("time");
    }

    function handleTime(choice) {
      state.answers.time = choice;
      saveState();
      goToStepKey("insight");
    }

    function handleInsight() {
      const el = document.getElementById("insight-input");
      const value = (el.value || "").trim();
      if (value) {
        state.answers.insight = value;
        saveState();
      }
      goToStepKey("extended1");
    }

    function handleExtended1() {
      const el = document.getElementById("extended1-input");
      const value = (el.value || "").trim();
      if (!value) {
        el.classList.add("input-error");
        return;
      }
      el.classList.remove("input-error");
      state.answers.extended1 = value;
      saveState();
      goToStepKey("extended2");
    }

    function handleExtended2() {
      const el = document.getElementById("extended2-input");
      const value = (el.value || "").trim();
      if (!value) {
        el.classList.add("input-error");
        return;
      }
      el.classList.remove("input-error");
      state.answers.extended2 = value;
      saveState();
      goToStepKey("email");
    }

    function handleEmail() {
      const el = document.getElementById("email-input");
      const value = (el.value || "").trim();
      if (!value || !value.includes("@")) {
        el.classList.add("input-error");
        return;
      }
      el.classList.remove("input-error");
      state.email = value;
      saveState();
      goToStepKey("processing");
    }

    function handleDailyStart() {
      goToStepKey("daily_intro");
    }

    function handleDailyCheckin() {
      const el = document.getElementById("daily-checkin-input");
      const value = (el.value || "").trim();
      if (!value) {
        el.classList.add("input-error");
        return;
      }
      el.classList.remove("input-error");
      state.answers.daily_checkin = value;
      addCheckin(value);
      saveState();
      goToStepKey("daily_summary");
    }

    function restartOnboarding() {
      clearState();
      goToStepKey("welcome");
    }

    function handleBackToHome() {
      const ref = document.referrer || "";
      if (ref.includes("index.html")) {
        window.location.href = "index.html";
      } else if (state.completed) {
        goToStepKey("home");
      } else {
        goToStepKey("welcome");
      }
    }

    function triggerInstall() {
      const container = document.getElementById("step-container");

      if (isInstalled) {
        goToStepKey("home");
        return;
      }

      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choice) => {
          deferredPrompt = null;

          if (choice.outcome === "accepted") {
            isInstalled = true;
            goToStepKey("home");
          } else {
            goToStepKey("home");
          }
        });
        return;
      }

      if (isDesktop) {
        container.innerHTML = `
          <div class="step step-centered">
            <h2>Install Peakora on your desktop</h2>
            <p class="soft-note">Install Peakora on your phone or tablet for the best experience — and it works beautifully on desktop too.</p>
            <p>On your laptop, look for the install icon in your browser’s address bar to add Peakora as an app.</p>
            <div class="actions" style="margin-top: 20px; justify-content: center;">
              <button class="btn secondary" onclick="goToStepKey('install_prompt')">Back</button>
              <button class="btn primary" onclick="goToStepKey('home')">Close</button>
            </div>
          </div>`;
      } else {
        container.innerHTML = `
          <div class="step step-centered">
            <h2>Add Peakora to your home screen</h2>
            <p class="soft-note">Install Peakora on your phone or tablet for the best experience. And if you ever want it on your laptop, that’s available too.</p>
            <p>From your browser menu, choose “Add to Home Screen” or “Install app” to keep Peakora close.</p>
            <div class="actions" style="margin-top: 20px; justify-content: center;">
              <button class="btn secondary" onclick="goToStepKey('install_prompt')">Back</button>
              <button class="btn primary" onclick="goToStepKey('home')">Close</button>
            </div>
          </div>`;
      }
    }

    /* MICRO-TOOLS */

    function openBreathReset() {
      const container = document.getElementById("step-container");
      container.innerHTML = `
        <div class="step step-centered">
          <h2>Breath Reset</h2>
          <p class="soft-note">For the next 10 seconds, let everything else wait.</p>
          <div class="breath-circle"></div>
          <p class="tiny-note">In through your nose as the circle grows. Out through your mouth as it softens.</p>
          <div class="actions" style="margin-top: 20px; justify-content: center;">
            <button class="btn secondary" onclick="goToStepKey('home')">Back to home</button>
          </div>
        </div>`;
    }

    function openMicroJournal() {
      const container = document.getElementById("step-container");
      container.innerHTML = `
        <div class="step">
          <h2>Micro‑Journal</h2>
          <p class="soft-note">Write one sentence about today. It doesn’t need to be profound. Just honest.</p>
          <textarea class="input" id="journal-input" placeholder="Today feels…"></textarea>
          <div class="actions">
            <button class="btn secondary" onclick="goToStepKey('home')">Back</button>
            <button class="btn primary" onclick="saveJournal()">Save</button>
          </div>
        </div>`;
    }

    function saveJournal() {
      const el = document.getElementById("journal-input");
      const value = (el.value || "").trim();
      if (!value) {
        el.classList.add("input-error");
        return;
      }
      el.classList.remove("input-error");
      const today = new Date().toISOString().slice(0, 10);
      const key = "peakora_journal_v1";
      const raw = localStorage.getItem(key);
      let list = [];
      try {
        list = raw ? JSON.parse(raw) : [];
      } catch {
        list = [];
      }
      list.push({ date: today, entry: value });
      localStorage.setItem(key, JSON.stringify(list.slice(-100)));
      goToStepKey("home");
    }

    function openHeavyDay() {
      const container = document.getElementById("step-container");
      container.innerHTML = `
        <div class="step">
          <h2>Today feels heavy</h2>
          <p class="soft-note">
            Pause. Drop your shoulders. Unclench your jaw.  
            You don’t have to fix anything in this moment.  
            Just soften the next minute.
          </p>
          <p>
            If all you do today is breathe a little slower and speak to yourself a little kinder, that is enough.
          </p>
          <div class="actions" style="margin-top: 20px; justify-content: center;">
            <button class="btn primary" onclick="goToStepKey('home')">Back to home</button>
          </div>
        </div>`;
    }

    function viewFullPlan() {
      const container = document.getElementById("step-container");
      const goal = state.answers.goal || "—";
      const win = state.answers.extended1 || "—";
      const habit = state.answers.extended2 || "—";
      const pace = state.answers.time || "—";

      container.innerHTML = `
        <div class="step">
          <h2>Your 7‑day plan snapshot</h2>
          <p><strong>Focus:</strong> ${goal}</p>
          <p><strong>Gentle win:</strong> ${win}</p>
          <p><strong>Anchor habit:</strong> ${habit}</p>
          <p><strong>Pace:</strong> ${pace}</p>
          <p class="soft-note">The full plan is in your inbox. This snapshot is here to remind you what you chose for yourself.</p>
          <div class="actions">
            <button class="btn primary" onclick="goToStepKey('home')">Back to home</button>
          </div>
        </div>`;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const hasState = loadState();
      if (!hasState) {
        goToStepKey("welcome");
        return;
      }
      if (state.completed) {
        goToStepKey("home");
        return;
      }
      goToStepKey(steps[state.stepIndex] || "welcome");
    });
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./service-worker.js");
    }
  </script>

</body>
</html>
